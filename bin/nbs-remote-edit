#!/bin/bash
# nbs-remote-edit: Edit files on remote machines via SSH
#
# Enables Claude agents to use their normal Edit/Read tools on remote files
# by syncing them via SSH. Eliminates the need for sed/heredoc editing
# through pty-session.
#
# Uses 'ssh cat' for file transfer (not scp/sftp) to work in environments
# where BpfJailer blocks the SFTP subsystem.
#
# Usage:
#   nbs-remote-edit pull <host> <remote-path>   Download file for local editing
#   nbs-remote-edit push <host> <remote-path>   Upload edited file back
#   nbs-remote-edit diff <host> <remote-path>   Show diff between local and remote
#   nbs-remote-edit help                         Show this help
#
# Environment:
#   NBS_REMOTE_EDIT_DIR   Local staging directory (default: .nbs/remote-edit)
#   NBS_REMOTE_EDIT_KEY   SSH identity file (optional)
#   NBS_REMOTE_EDIT_PORT  SSH port (default: 22)
#
# Examples:
#   nbs-remote-edit pull devserver.example.com /data/users/dev/project/src/main.cpp
#   # Now edit .nbs/remote-edit/devserver.example.com/data/users/dev/project/src/main.cpp
#   # using the normal Edit tool
#   nbs-remote-edit push devserver.example.com /data/users/dev/project/src/main.cpp
#
# Exit codes:
#   0 - Success
#   1 - General error
#   2 - File not found (remote or local)
#   3 - SSH connection failed
#   4 - Invalid arguments

set -euo pipefail

STAGING_DIR="${NBS_REMOTE_EDIT_DIR:-.nbs/remote-edit}"
SSH_KEY="${NBS_REMOTE_EDIT_KEY:-}"
SSH_PORT="${NBS_REMOTE_EDIT_PORT:-22}"

usage() {
    grep '^#' "$0" | grep -v '!/bin/bash' | cut -c3-
}

ssh_cmd() {
    local host="$1"
    shift
    local opts="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 -p $SSH_PORT"
    if [[ -n "$SSH_KEY" ]]; then
        opts="$opts -i $SSH_KEY"
    fi
    # shellcheck disable=SC2086
    ssh $opts "$host" "$@"
}

local_path() {
    local host="$1"
    local remote_path="$2"
    echo "${STAGING_DIR}/${host}${remote_path}"
}

cmd_pull() {
    local host="${1:-}"
    local remote_path="${2:-}"

    if [[ -z "$host" ]] || [[ -z "$remote_path" ]]; then
        echo "Error: pull requires <host> and <remote-path>" >&2
        echo "Usage: nbs-remote-edit pull <host> <remote-path>" >&2
        return 4
    fi

    local lpath
    lpath=$(local_path "$host" "$remote_path")
    local ldir
    ldir=$(dirname "$lpath")

    mkdir -p "$ldir"

    # Download via ssh cat (avoids scp/sftp which BpfJailer may block)
    if ! ssh_cmd "$host" "cat $(printf '%q' "$remote_path")" > "$lpath" 2>/dev/null; then
        rm -f "$lpath"
        echo "Error: Failed to download ${host}:${remote_path}" >&2
        echo "Check: SSH connectivity, file exists, permissions" >&2
        return 3
    fi

    # Verify we got content (ssh cat of nonexistent file may succeed with empty output)
    if [[ ! -s "$lpath" ]]; then
        # Check if remote file exists
        if ! ssh_cmd "$host" "test -f $(printf '%q' "$remote_path")" 2>/dev/null; then
            rm -f "$lpath"
            echo "Error: Remote file not found: ${host}:${remote_path}" >&2
            return 2
        fi
    fi

    echo "$lpath"
}

cmd_push() {
    local host="${1:-}"
    local remote_path="${2:-}"

    if [[ -z "$host" ]] || [[ -z "$remote_path" ]]; then
        echo "Error: push requires <host> and <remote-path>" >&2
        echo "Usage: nbs-remote-edit push <host> <remote-path>" >&2
        return 4
    fi

    local lpath
    lpath=$(local_path "$host" "$remote_path")

    if [[ ! -f "$lpath" ]]; then
        echo "Error: Local file not found: $lpath" >&2
        echo "Did you run 'nbs-remote-edit pull' first?" >&2
        return 2
    fi

    # Upload via ssh cat (pipe local file to remote cat > file)
    if ! ssh_cmd "$host" "cat > $(printf '%q' "$remote_path")" < "$lpath" 2>/dev/null; then
        echo "Error: Failed to upload to ${host}:${remote_path}" >&2
        return 3
    fi

    echo "Pushed: ${remote_path} -> ${host}"
}

cmd_diff() {
    local host="${1:-}"
    local remote_path="${2:-}"

    if [[ -z "$host" ]] || [[ -z "$remote_path" ]]; then
        echo "Error: diff requires <host> and <remote-path>" >&2
        return 4
    fi

    local lpath
    lpath=$(local_path "$host" "$remote_path")

    if [[ ! -f "$lpath" ]]; then
        echo "Error: Local file not found: $lpath" >&2
        return 2
    fi

    local tmp
    tmp=$(mktemp)
    trap "rm -f '$tmp'" RETURN

    if ! ssh_cmd "$host" "cat $(printf '%q' "$remote_path")" > "$tmp" 2>/dev/null; then
        echo "Error: Failed to download ${host}:${remote_path} for diff" >&2
        return 3
    fi

    diff -u "$tmp" "$lpath" --label "remote:${remote_path}" --label "local:${lpath}" || true
}

# Main dispatch
case "${1:-}" in
    pull)
        shift
        cmd_pull "$@"
        ;;
    push)
        shift
        cmd_push "$@"
        ;;
    diff)
        shift
        cmd_diff "$@"
        ;;
    help|--help|-h|"")
        usage
        ;;
    *)
        echo "Unknown command: $1" >&2
        echo "Run 'nbs-remote-edit help' for usage" >&2
        exit 4
        ;;
esac
